{"ast":null,"code":"\"use strict\";\n\nvar __importDefault = this && this.__importDefault || function (mod) {\n  return mod && mod.__esModule ? mod : {\n    \"default\": mod\n  };\n};\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.redactFields = exports.redactHeaders = exports.buildPayload = void 0;\nconst jsonpath_1 = __importDefault(require(\"jsonpath\"));\nfunction buildPayload(start_time, req, res, reqBody, respBody, redactRequestBody, redactResponseBody, redactHeaderLists, project_id, errors, service_version, tags, msg_id, parent_id) {\n  const reqObjEntries = Object.entries(req.headers).map(([k, v]) => [k, Array.isArray(v) ? v : [v]]);\n  const reqHeaders = new Map(reqObjEntries);\n  console.log(\"req\", req.headers, reqHeaders);\n  const resObjEntries = Object.entries(res.getHeaders()).map(([k, v]) => [k, Array.isArray(v) ? v : [v]]);\n  const resHeaders = new Map(resObjEntries);\n  console.log(\"res\", res.getHeaders, resHeaders);\n  const queryObjEntries = Object.entries(req.query).map(([k, v]) => {\n    if (typeof v === \"string\") return [k, [v]];\n    return [k, v];\n  });\n  const queryParams = Object.fromEntries(queryObjEntries);\n  const pathParams = req.params ?? {};\n  let urlPath = req.route?.path ?? \"\";\n  if (req.baseUrl && req.baseUrl !== \"\") {\n    urlPath = req.baseUrl + urlPath;\n  }\n  const payload = {\n    duration: Number(process.hrtime.bigint() - start_time),\n    host: req.hostname,\n    method: req.method,\n    path_params: pathParams,\n    project_id: project_id,\n    proto_minor: 1,\n    proto_major: 1,\n    query_params: queryParams,\n    raw_url: req.originalUrl,\n    referer: req.headers.referer ?? \"\",\n    request_body: Buffer.from(redactFields(reqBody, redactRequestBody)).toString(\"base64\"),\n    request_headers: redactHeaders(reqHeaders, redactHeaderLists),\n    response_body: Buffer.from(redactFields(respBody, redactResponseBody)).toString(\"base64\"),\n    response_headers: redactHeaders(resHeaders, redactHeaderLists),\n    sdk_type: \"JsExpress\",\n    status_code: res.statusCode,\n    timestamp: new Date().toISOString(),\n    url_path: urlPath,\n    errors,\n    service_version,\n    tags,\n    msg_id,\n    parent_id\n  };\n  console.log(payload);\n  return payload;\n}\nexports.buildPayload = buildPayload;\nfunction redactHeaders(headers, headersToRedact) {\n  const redactedHeaders = {};\n  const headersToRedactLowerCase = headersToRedact.map(header => header.toLowerCase());\n  for (let [key, value] of headers) {\n    const lowerKey = key.toLowerCase();\n    const isRedactKey = headersToRedactLowerCase.includes(lowerKey) || lowerKey === \"cookie\";\n    redactedHeaders[key] = isRedactKey ? [\"[CLIENT_REDACTED]\"] : value;\n  }\n  return redactedHeaders;\n}\nexports.redactHeaders = redactHeaders;\nfunction redactFields(body, fieldsToRedact) {\n  try {\n    const bodyOB = JSON.parse(body);\n    fieldsToRedact.forEach(path => {\n      jsonpath_1.default.apply(bodyOB, path, function () {\n        return \"[CLIENT_REDACTED]\";\n      });\n    });\n    return JSON.stringify(bodyOB);\n  } catch (error) {\n    return body;\n  }\n}\nexports.redactFields = redactFields;","map":{"version":3,"names":["__importDefault","mod","__esModule","Object","defineProperty","exports","value","redactFields","redactHeaders","buildPayload","jsonpath_1","require","start_time","req","res","reqBody","respBody","redactRequestBody","redactResponseBody","redactHeaderLists","project_id","errors","service_version","tags","msg_id","parent_id","reqObjEntries","entries","headers","map","k","v","Array","isArray","reqHeaders","Map","console","log","resObjEntries","getHeaders","resHeaders","queryObjEntries","query","queryParams","fromEntries","pathParams","params","urlPath","route","path","baseUrl","payload","duration","Number","process","hrtime","bigint","host","hostname","method","path_params","proto_minor","proto_major","query_params","raw_url","originalUrl","referer","request_body","Buffer","from","toString","request_headers","response_body","response_headers","sdk_type","status_code","statusCode","timestamp","Date","toISOString","url_path","headersToRedact","redactedHeaders","headersToRedactLowerCase","header","toLowerCase","key","lowerKey","isRedactKey","includes","body","fieldsToRedact","bodyOB","JSON","parse","forEach","default","apply","stringify","error"],"sources":["C:/Users/Ігор/clone/node_modules/apitoolkit-express/payload.js"],"sourcesContent":["\"use strict\";\nvar __importDefault = (this && this.__importDefault) || function (mod) {\n    return (mod && mod.__esModule) ? mod : { \"default\": mod };\n};\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.redactFields = exports.redactHeaders = exports.buildPayload = void 0;\nconst jsonpath_1 = __importDefault(require(\"jsonpath\"));\nfunction buildPayload(start_time, req, res, reqBody, respBody, redactRequestBody, redactResponseBody, redactHeaderLists, project_id, errors, service_version, tags, msg_id, parent_id) {\n    const reqObjEntries = Object.entries(req.headers).map(([k, v]) => [k, Array.isArray(v) ? v : [v]]);\n    const reqHeaders = new Map(reqObjEntries);\n    console.log(\"req\", req.headers, reqHeaders);\n    const resObjEntries = Object.entries(res.getHeaders()).map(([k, v]) => [k, Array.isArray(v) ? v : [v]]);\n    const resHeaders = new Map(resObjEntries);\n    console.log(\"res\", res.getHeaders, resHeaders);\n    const queryObjEntries = Object.entries(req.query).map(([k, v]) => {\n        if (typeof v === \"string\")\n            return [k, [v]];\n        return [k, v];\n    });\n    const queryParams = Object.fromEntries(queryObjEntries);\n    const pathParams = req.params ?? {};\n    let urlPath = req.route?.path ?? \"\";\n    if (req.baseUrl && req.baseUrl !== \"\") {\n        urlPath = req.baseUrl + urlPath;\n    }\n    const payload = {\n        duration: Number(process.hrtime.bigint() - start_time),\n        host: req.hostname,\n        method: req.method,\n        path_params: pathParams,\n        project_id: project_id,\n        proto_minor: 1,\n        proto_major: 1,\n        query_params: queryParams,\n        raw_url: req.originalUrl,\n        referer: req.headers.referer ?? \"\",\n        request_body: Buffer.from(redactFields(reqBody, redactRequestBody)).toString(\"base64\"),\n        request_headers: redactHeaders(reqHeaders, redactHeaderLists),\n        response_body: Buffer.from(redactFields(respBody, redactResponseBody)).toString(\"base64\"),\n        response_headers: redactHeaders(resHeaders, redactHeaderLists),\n        sdk_type: \"JsExpress\",\n        status_code: res.statusCode,\n        timestamp: new Date().toISOString(),\n        url_path: urlPath,\n        errors,\n        service_version,\n        tags, msg_id, parent_id,\n    };\n    console.log(payload);\n    return payload;\n}\nexports.buildPayload = buildPayload;\nfunction redactHeaders(headers, headersToRedact) {\n    const redactedHeaders = {};\n    const headersToRedactLowerCase = headersToRedact.map((header) => header.toLowerCase());\n    for (let [key, value] of headers) {\n        const lowerKey = key.toLowerCase();\n        const isRedactKey = headersToRedactLowerCase.includes(lowerKey) || lowerKey === \"cookie\";\n        redactedHeaders[key] = isRedactKey ? [\"[CLIENT_REDACTED]\"] : value;\n    }\n    return redactedHeaders;\n}\nexports.redactHeaders = redactHeaders;\nfunction redactFields(body, fieldsToRedact) {\n    try {\n        const bodyOB = JSON.parse(body);\n        fieldsToRedact.forEach((path) => {\n            jsonpath_1.default.apply(bodyOB, path, function () {\n                return \"[CLIENT_REDACTED]\";\n            });\n        });\n        return JSON.stringify(bodyOB);\n    }\n    catch (error) {\n        return body;\n    }\n}\nexports.redactFields = redactFields;\n"],"mappings":"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"},"metadata":{},"sourceType":"script","externalDependencies":[]}